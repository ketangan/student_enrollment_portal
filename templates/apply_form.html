{% load static %}
{% load form_extras %}
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>{{ school.display_name|default:school.slug }} - Apply</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="{% static 'forms.css' %}">

    <!-- Phase 9: YAML-driven theme variables (no if-else) -->
    <style>
      :root{
        --primary: {{ branding.theme.accent_color }};
        --bg: {{ branding.theme.background }};
        --card: {{ branding.theme.card }};
        --text: {{ branding.theme.text }};
        --muted: {{ branding.theme.muted }};
        --border: {{ branding.theme.border }};
        --radius: {{ branding.theme.radius }};
      }
    </style>

    <!-- Phase 9: optional per-school CSS override -->
    {% if branding.custom_css %}
      <link rel="stylesheet" href="{% static branding.custom_css %}">
    {% endif %}
  </head>

  <body>
    <div class="page">
      <div class="container">

        <!-- Header -->
        <div class="header">
          <div class="school-logo">
            {% if branding.logo_url %}
              <img src="{{ branding.logo_url }}" alt="logo" style="width:100%; height:100%; object-fit:cover;" />
            {% else %}
              <span aria-hidden="true">üè´</span>
            {% endif %}
          </div>

          <div>
            <div class="school-title">{{ school.display_name|default:school.slug }}</div>
            <div class="school-subtitle">{{ form.title }}</div>
          </div>
        </div>

        {% if form.description %}
          <div class="notice">{{ form.description }}</div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" novalidate>
          {% csrf_token %}

          {% for section in form.sections %}
            <div class="card">
              <div class="section-title">{{ section.title }}</div>

              {% if section.description %}
                <div class="help" style="margin-top:-6px; margin-bottom:12px;">{{ section.description }}</div>
              {% endif %}

              <div class="grid">
                {% for field in section.fields %}
                  {# Field wrapper (some fields full width) #}
                  <div class="
                    {% if field.type == 'textarea' %}span-2{% endif %}
                    {% if field.type == 'file' %}span-2{% endif %}
                    {% if field.full_width %}span-2{% endif %}
                  ">

                    {# Standard label (not for checkbox) #}
                    {% if field.type != "checkbox" and field.type != "multiselect" %}
                    <label class="label" for="{{ field.key }}">
                        {{ field.label }}
                        {% if field.required %}<span class="required">*</span>{% endif %}
                    </label>
                    {% elif field.type == "multiselect" and field.ui != "checkboxes" %}
                    <label class="label" for="{{ field.key }}">
                        {{ field.label }}
                        {% if field.required %}<span class="required">*</span>{% endif %}
                    </label>
                    {% endif %}

                    {# --- TEXTAREA --- #}
                    {% if field.type == "textarea" %}
                      <textarea
                        class="input"
                        id="{{ field.key }}"
                        name="{{ field.key }}"
                        placeholder="{{ field.placeholder|default:'' }}"
                      >{{ values|get_item:field.key }}</textarea>

                    {# --- SELECT --- #}
                    {% elif field.type == "select" %}
                      <select class="input" id="{{ field.key }}" name="{{ field.key }}">
                        <option value="">Select...</option>
                        {% for opt in field.options %}
                          <option value="{{ opt.value }}" {% if values|get_item:field.key == opt.value %}selected{% endif %}>
                            {{ opt.label }}
                          </option>
                        {% endfor %}
                      </select>

                    {# --- MULTISELECT (checkbox list) --- #}
                    {% elif field.type == "multiselect" and field.ui == "checkboxes" %}
                      <div class="label" style="margin-bottom:8px;">
                        {{ field.label }}
                        {% if field.required %}<span class="required">*</span>{% endif %}
                      </div>

                      <div class="checklist">
                        {% for opt in field.options %}
                          <label class="check-item">
                            <input
                              class="check"
                              type="checkbox"
                              name="{{ field.key }}"
                              value="{{ opt.value }}"
                              {% if values|get_item:field.key and opt.value in values|get_item:field.key %}checked{% endif %}
                            />
                            <span>{{ opt.label }}</span>
                          </label>
                        {% endfor %}
                      </div>

                    {# --- MULTISELECT (fallback native select) --- #}
                    {% elif field.type == "multiselect" %}
                      <select class="input" id="{{ field.key }}" name="{{ field.key }}" multiple>
                        {% for opt in field.options %}
                          <option
                            value="{{ opt.value }}"
                            {% if values|get_item:field.key and opt.value in values|get_item:field.key %}selected{% endif %}
                          >
                            {{ opt.label }}
                          </option>
                        {% endfor %}
                      </select>
                      <div class="help">Hold ‚åò (Mac) / Ctrl (Windows) to select multiple.</div>

                    {# --- CHECKBOX --- #}
                    {% elif field.type == "checkbox" %}
                      <div class="check-row">
                        <input
                          class="check"
                          id="{{ field.key }}"
                          name="{{ field.key }}"
                          type="checkbox"
                          value="true"
                          {% if values|get_item:field.key %}checked{% endif %}
                        />
                        <label class="check-label" for="{{ field.key }}">
                          {{ field.checkbox_label|default:field.label }}
                          {% if field.required %}<span class="required">*</span>{% endif %}
                        </label>
                      </div>

                    {# --- EMAIL --- #}
                    {% elif field.type == "email" %}
                      <input
                        class="input"
                        id="{{ field.key }}"
                        name="{{ field.key }}"
                        type="email"
                        value="{{ values|get_item:field.key }}"
                        placeholder="{{ field.placeholder|default:'' }}"
                      />

                    {# --- PHONE --- #}
                    {% elif field.type == "phone" %}
                      <input
                        class="input"
                        id="{{ field.key }}"
                        name="{{ field.key }}"
                        type="tel"
                        value="{{ values|get_item:field.key }}"
                        placeholder="{{ field.placeholder|default:'' }}"
                      />

                    {# --- DATE --- #}
                    {% elif field.type == "date" %}
                      <input
                        class="input"
                        id="{{ field.key }}"
                        name="{{ field.key }}"
                        type="date"
                        value="{{ values|get_item:field.key }}"
                      />

                    {# --- NUMBER (special: age readonly + auto-populate) --- #}
                    {% elif field.type == "number" and field.key == "age" %}
                        <input
                            class="input input-readonly"
                            id="age"
                            name="age"
                            type="number"
                            value="{{ values|get_item:'age' }}"
                            readonly
                            tabindex="-1"
                        />

                    {# --- NUMBER (generic) --- #}
                    {% elif field.type == "number" %}
                      <input
                        class="input"
                        id="{{ field.key }}"
                        name="{{ field.key }}"
                        type="number"
                        value="{{ values|get_item:field.key }}"
                        placeholder="{{ field.placeholder|default:'' }}"
                      />

                    {# --- FILE placeholder (Phase 4-ready) --- #}
                    {% elif field.type == "file" %}
                      <input
                        class="input"
                        id="{{ field.key }}"
                        name="{{ field.key }}"
                        type="file"
                        {% if field.accept %} accept="{{ field.accept }}" {% endif %}
                        {% if field.required %} required {% endif %}
                      />

                    {# --- DEFAULT TEXT --- #}
                    {% else %}
                      <input
                        class="input"
                        id="{{ field.key }}"
                        name="{{ field.key }}"
                        type="text"
                        value="{{ values|get_item:field.key }}"
                        placeholder="{{ field.placeholder|default:'' }}"
                      />
                    {% endif %}

                    {% if field.help_text %}
                      <div class="help">{{ field.help_text }}</div>
                    {% endif %}

                    {% if errors|get_item:field.key %}
                      <div class="error">{{ errors|get_item:field.key }}</div>
                    {% endif %}
                  </div>
                {% endfor %}
              </div>
            </div>
          {% endfor %}

          <!-- Submit (not its own card) -->
          <div class="actions">
            <button class="btn btn-primary" type="submit">
              {{ form.submit_button_text|default:"Submit" }}
            </button>
          </div>
        </form>

      </div>
    </div>

    <script>
        (function () {
            const dob = document.getElementById("date_of_birth");
            const age = document.getElementById("age");
            if (!dob || !age) return;

            // Optional: constrain picker; does not block typing reliably but helps picker users
            const todayISO = new Date().toISOString().slice(0, 10);
            dob.setAttribute("max", todayISO);
            dob.setAttribute("min", "1900-01-01");

            function isValidISODate(s) {
            return /^\d{4}-\d{2}-\d{2}$/.test(s);
            }

            function calcAge(isoDateStr) {
            const d = new Date(isoDateStr);
            if (isNaN(d.getTime())) return "";

            const today = new Date();
            let years = today.getFullYear() - d.getFullYear();
            const m = today.getMonth() - d.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < d.getDate())) years--;
            return years >= 0 ? years : "";
            }

            function isRealisticDOB(iso) {
            if (!isValidISODate(iso)) return false;

            const d = new Date(iso);
            if (isNaN(d.getTime())) return false;

            const year = d.getFullYear();
            if (year < 1900) return false;
            if (d > new Date()) return false;

            const a = calcAge(iso);
            if (a === "" || a > 120) return false;

            return true;
            }

            // No popups. No custom validity. Never blocks typing.
            function maybeUpdateAge() {
            const iso = dob.value;

            if (!isValidISODate(iso)) {
                // user is mid-typing / incomplete
                age.value = "";
                return;
            }

            if (!isRealisticDOB(iso)) {
                // complete date but unrealistic -> clear computed field
                age.value = "";
                return;
            }

            age.value = calcAge(iso);
            }

            // Update on commit events only (not on each keystroke)
            dob.addEventListener("change", maybeUpdateAge);
            dob.addEventListener("blur", maybeUpdateAge);

            // On load
            maybeUpdateAge();
        })();
    </script>

    {% if branding.custom_js %}
      <script defer src="{% static branding.custom_js %}"></script>
    {% endif %}
  </body>
</html>
